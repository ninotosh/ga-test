on:
  push:
    branches:
      - master
jobs:
  copy-dir:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2-beta
        with:
          ref: refs/heads/master
      - run: ls -alFR $GITHUB_WORKSPACE
      - run: cd $GITHUB_WORKSPACE
      - run: git branch copy-dir-${GITHUB_SHA}
      - run: git checkout copy-dir-${GITHUB_SHA}
      - run: mkdir -p copy-github
      - run: cp -r .github/* copy-github
      - id: check-diff
        run: |
          result=`git diff --name-only | grep -E '^.github/'; echo $?`
          echo ::set-output name=exists::$result
      - if: steps.check-diff.outputs.exists == '0'
        run: |
          git add .
          git config user.name "${GITHUB_ACTOR}"
          git commit -m "copy after ${GITHUB_SHA}"
          git push origin copy-dir-${GITHUB_SHA}
      - if: steps.check-diff.outputs.exists == '0'
        uses: actions/github-script@0.3.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.pulls.create({
              owner: context.payload.repository.owner.name,
              repo: context.payload.repository.name,
              title: `copy after ${process.env.GITHUB_SHA}`,
              head: `copy-dir-${process.env.GITHUB_SHA}`,
              base: "master",
              body: `copy after ${process.env.GITHUB_SHA}`
            })
